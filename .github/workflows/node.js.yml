# This workflow will do a clean installation of node dependencies, cache/restore them, build the source code and run tests across different versions of node
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-nodejs

name: Build & Deploy (GitHub Pages)

on:
  push:
    branches: [ "main" ]

  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (manual)
        shell: bash
        env:
          REPO: ${{ github.repository }}
          REF: ${{ github.ref_name }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          rm -rf repo
          git clone --depth 1 --branch "$REF" "https://x-access-token:${TOKEN}@github.com/${REPO}.git" repo

      - name: Build
        shell: bash
        run: |
          set -euo pipefail
          cd repo
          node --version
          npm --version
          npm ci
          npm run build

      - name: Deploy (push dist to gh-pages)
        if: github.ref == 'refs/heads/main'
        shell: bash
        env:
          REPO: ${{ github.repository }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          cd repo

          if [ ! -d dist ]; then
            echo "dist folder not found; build may have failed." >&2
            exit 1
          fi

          cd dist
          touch .nojekyll
          # SPA fallback for GitHub Pages: serve index for deep links
          cp index.html 404.html

          git init
          git checkout -b gh-pages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Deploy to GitHub Pages" || true
          git remote add origin "https://x-access-token:${TOKEN}@github.com/${REPO}.git"
          git push --force origin gh-pages
